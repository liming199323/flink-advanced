# Table-API
Flink 根据使用的便捷性和表达能力的强弱提供了 3 层 API，由上到下，表达能力逐渐增强

比如 processFunction，是最底层的 API，表达能力最强，我们可以用他来操作 state 和 timer 等复杂功能。

Datastream API 相对于 processFunction 来说，又进行了进一步封装，提供了很多标准的语义算子给大家使用，比如我们常用的 window 算子（包括 Tumble, slide,session 等）。

那么最上面的 SQL 和 Table API 使用最为便捷，具有自身的很多特点.

## 特点
- Table API & SQL 是一种声明式的 API。用户只需关心做什么，不用关心怎么做，比如图中的 WordCount 例子，只需要关心按什么维度聚合，做哪种类型的聚合，不需要关心底层的实现。
- 高性能。Table API & SQL 底层会有优化器对 query 进行优化。举个例子，假如 WordCount 的例子里写了两个 count 操作，优化器会识别并避免重复的计算，计算的时候只保留一个 count 操作，输出的时候再把相同的值输出两遍即可，以达到更好的性能。
- 流批统一。上图例子可以发现，API 并没有区分流和批，同一套 query 可以流批复用，对业务开发来说，避免开发两套代码。
- 标准稳定。Table API & SQL 遵循 SQL 标准，不易变动。API 比较稳定的好处是不用考虑 API 兼容性问题。
- 易理解。语义明确，所见即所得。

# 获取 Table
大体分为两步
1. 注册对应的 TableSource
    - 通过 Table descriptor 来注册
    - 通过自定义 source 来注册
    - 通过 DataStream 来注册
2. 调用 Table environement 的 scan 方法获取 Table 对象

具体的注册方式如下:
- batch
    - java
        - org.apache.flink.api.java.ExecutionEnvironment
        - org.apache.flink.table.api.java.BatchTableEnvironment
    - scala 
        - org.apache.flink.api.scala.ExecutionEnvironment
        - org.apache.flink.table.api.scala.BatchTableEnvironment
- stream
    - java
        - org.apache.flink.streaming.api.environment.StreamExecutionEnvironment
        - org.apache.flink.table.api.java.StreamTableEnvironment
    - scala 
        - org.apache.flink.streaming.api.scala.StreamExecutionEnvironment
        - org.apache.flink.table.api.scala.StreamTableEnvironment
        
# 输出 Table
- Table descriptor
- 自定义 Table Sink 
- 输出成一个 DataStream        
# 操作 Table
## 操作总览
![](https://ververica.cn/wp-content/uploads/2019/08/06-api_on_table-1024x570.png)
## 易用性相关操作
addColumns, addOrReplaceColumns 和 renameColumns 、withColumns 和 withoutColumns

> `table.select(“withColumns(20 to 80)”)`
## 增强性相关操作
Flink 里有自定义函数
- ScalarFunction    输入一行，输出一行
- TableFunction     输入一行，输出多行
- AggregateFunction 输入多行输出一行
- TableAggregateFunction    输入输出多行

# Table API 动态
- cache算子   https://issues.apache.org/jira/browse/FLINK-11199
- iterator算子    https://issues.apache.org/jira/browse/FLINK-11199
